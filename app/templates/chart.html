{% extends "base.html" %}

{% block content %}
<div class="container chart-border rounded p-3 mb-4">
    <h1 class="text-center">{{ league_name }} Current Standings</h1>
    <div class="table-responsive">
    <table id="cltStandingsTable" class="table table-striped table-bordered table-hover align-middle text-center">
        <thead>
            <tr>
                {% for col in clt_col_names %}
                <th scope="col" class="expected-table-custom-blue text-center">{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in clt_row_data %}
            <tr>
                {% for col, row_ in zip(clt_col_names, row) %}
                <td>{{ row_ }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table> 
</div>
</div>
<br>
<div class="container chart-border rounded p-3 mb-4">
    <h1 class="text-center">Average Points For vs Average Points Against</h1>
    <div class="container">
        <canvas id="scatter_avg_points"></canvas>
    </div>
</div>
<br>
<div class="container chart-border rounded p-3 mb-4">
    <h1 class="text-center">Expected Standings</h1>
    <div class="table-responsive">
    <table id="xltStandingsTable" class="table table-striped table-bordered table-hover align-middle text-center">
        <thead>
            <tr>
                {% for col in xlt_col_names %}
                <th scope="col" class="expected-table-custom-blue text-center">{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in xlt_row_data %}
            <tr>
                {% for col, row_ in zip(xlt_col_names, row) %}
                <td>{{ row_ }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    <p>
        Expected points are used to determine how lucky or unlucky each player is. For a head-to-head league in any
        given
        gameweek, if you score the most fpl points, your expected points are 3 because no one can beat you. In a
        gameweek,
        if you score the 3rd highest fpl points in a 10 person league, you beat 7 people but lose to 2 so your expected
        points work out as 7/(7+2) * 3 = 2.33. Add the expected points for each player every week and you get the
        expected
        league table. The over/under performance determines how lucky/unlucky players are.
    </p>
</div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        $('#cltStandingsTable').DataTable({
            paging: false,
            searching: false,
            ordering: true,
            info: false,
            pageLength: 16,
            order: [[1, "asc"]]
        });

        $('#xltStandingsTable').DataTable({
            paging: false,
            searching: false,
            ordering: true,
            info: false,
            pageLength: 16,
            order: [[2, "desc"]]
        });
    });

    // Register Chart.js plugin
    Chart.register(ChartDataLabels);

    const ctx3 = document.getElementById('scatter_avg_points').getContext('2d');
    const chart_labels = {{ labels | safe }};

    const data_flask = {
            datasets: [{
                data: {{ data_dict | tojson() }},
        backgroundColor: 'rgb(255, 99, 132)',
        }],
    };

    // Extract x and y values from your scatter dataset
    const xs = data_flask.datasets[0].data.map(pt => pt.x);
    const ys = data_flask.datasets[0].data.map(pt => pt.y);

    // Helper functions to round to nearest multiple of 5
    function roundUpToMultipleOf5(n) {
        return Math.ceil((n + 1) / 5) * 5;
    }
    function roundDownToMultipleOf5(n) {
        return Math.floor((n - 1) / 5) * 5;
    }

    // Compute axis limits without extra padding
    const xMin = roundDownToMultipleOf5(Math.min(...xs));
    const xMax = roundUpToMultipleOf5(Math.max(...xs));
    const yMin = roundDownToMultipleOf5(Math.min(...ys));
    const yMax = roundUpToMultipleOf5(Math.max(...ys));


    const scatterchart = new Chart(ctx3, {
        type: 'scatter',
        data: data_flask,
        options: {
            radius: 4,
            pointBackgroundColor: '#62A6F8',
            plugins: {
                title: {
                    display: false,
                    text: 'Average Points For vs Average Points Against',
                    font: { size: 30 },
                    color: 'black'
                },
                datalabels: {
                    display: true,
                    align: 'start',
                    color: '#214672',
                    font: { size: 16 },
                    formatter: function (value, ctx) {
                        return chart_labels[ctx.dataIndex];
                    }
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    min: yMin,
                    max: yMax,
                    ticks: {
                        stepSize: 5   // force tick marks every 5
                    },
                    title: {
                        display: true,
                        text: 'Average points against',
                        font: { size: 18 },
                        color: 'black'
                    }
                },
                x: {
                    min: xMin,
                    max: xMax,
                    ticks: {
                        stepSize: 5   // force tick marks every 5
                    },
                    title: {
                        display: true,
                        text: 'Average points for',
                        font: { size: 18 },
                        color: 'black'
                    }
                }
            }
        }
    });
</script>
{% endblock %}